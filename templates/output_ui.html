<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Analyzer Output</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 18px; color:#111 }
    .controls { margin-bottom: 12px; display:flex; gap:8px; align-items:center }
    input[type=text] { padding:6px; font-size:14px; width:320px }
    button { padding:8px 12px; font-size:14px; cursor:pointer }
    .ticker { border:1px solid #e1e4e8; padding:12px; margin-bottom:14px; border-radius:8px; background:#fff }
    .header { display:flex; justify-content:space-between; align-items:center; gap:12px }
    .chart { max-width:420px; max-height:260px; border:1px solid #ddd; margin-top:8px; display:flex; align-items:center; justify-content:center; }
    .timeframe { margin-top:10px; border-top:1px dashed #eee; padding-top:10px }
    .rec-row { display:flex; gap:12px; margin-top:8px; flex-wrap:wrap }
    .card { flex:1 1 320px; border:1px solid #ddd; padding:10px; border-radius:6px; background:#fafafa }
    .muted { color:#666; font-size:13px }
    table { border-collapse: collapse; width:100% }
    td, th { padding:6px 8px; border-bottom:1px solid #f1f1f1; font-size:13px }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#eef; font-size:12px; color:#045 }
    .warning { color:#a33 }
    .ok { color:#166 }
  </style>
</head>
<body>
  <h2>Daily Option Strategy Analyzer — Output</h2>

  <div class="controls">
    <input id="stocks" type="text" value='["9988.HK","0005.HK","1810.HK"]' />
    <input id="index" type="text" value="^HSI" />
    <button id="run">Run Analyze</button>
    <button id="force">Run + Force Refresh</button>
    <span id="status" class="muted"></span>
  </div>

  <div id="results"></div>

  <script>
    async function callAnalyze(forceRefresh) {
      const runBtn = document.getElementById('run');
      const forceBtn = document.getElementById('force');
      runBtn.disabled = true; forceBtn.disabled = true;
      const status = document.getElementById('status');
      status.textContent = "Running…";
      try {
        const stocksVal = document.getElementById('stocks').value;
        const indexVal = document.getElementById('index').value || "^HSI";
        const body = { stocks: JSON.parse(stocksVal), index: indexVal };
        if (forceRefresh) {
          try { await fetch('/clear-cache', { method: 'POST' }); } catch(e) { /* ignore */ }
        }
        const resp = await fetch('/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const payload = await resp.json();
        renderResults(payload);
        status.textContent = "Done: " + payload.timestamp;
      } catch (err) {
        status.textContent = "Error: " + (err && err.message || err);
      } finally {
        runBtn.disabled = false; forceBtn.disabled = false;
      }
    }

    function short(val, n=6) {
      try { return (typeof val === 'number') ? val.toFixed(n) : String(val).slice(0,80); } catch(e){ return String(val) }
    }

    function renderResults(payload) {
      const out = document.getElementById('results');
      out.innerHTML = "";
      if (!payload || !payload.results) { out.textContent = "No results"; return; }
      for (const [ticker, info] of Object.entries(payload.results)) {
        const div = document.createElement('div');
        div.className = 'ticker';
        const header = document.createElement('div');
        header.className = 'header';
        header.innerHTML = `<div><strong>${ticker}</strong> <span class="muted">latest</span> <strong>${info.latest ?? '-'}</strong></div>
                            <div><span class="${info.iv_surface_fitted ? 'ok' : 'warning'}">${info.iv_surface_fitted ? 'IV surface fitted' : 'No IV surface'}</span></div>`;
        div.appendChild(header);

        if (info.chart) {
          const img = document.createElement('img');
          img.className = 'chart';
          img.src = info.chart;
          img.alt = ticker + " chart";
          img.style.maxWidth = '420px';
          img.style.maxHeight = '260px';
          div.appendChild(img);
        } else {
          const ph = document.createElement('div');
          ph.className = 'chart';
          ph.style.color = '#666';
          ph.textContent = 'Chart unavailable';
          div.appendChild(ph);
        }

        const summary = info.summary || {};
        for (const [tf, block] of Object.entries(summary)) {
          const tfDiv = document.createElement('div');
          tfDiv.className = 'timeframe';
          tfDiv.innerHTML = `<div><strong>${tf}</strong> — score: <span class="muted">${block.score}</span></div>`;
          const row = document.createElement('div'); row.className = 'rec-row';
          const p1 = makeCard(block.recommendation_by_policy.prefer_spread, 'Prefer Spread');
          const p2 = makeCard(block.recommendation_by_policy.allow_naked, 'Allow Naked');
          row.appendChild(p1); row.appendChild(p2);
          tfDiv.appendChild(row);
          const comps = block.components || {};
          const compTbl = document.createElement('table');
          let rows = '<tr><th>Indicator</th><th>Value</th></tr>';
          for (const k of Object.keys(comps)) rows += `<tr><td>${k}</td><td>${short(comps[k])}</td></tr>`;
          compTbl.innerHTML = rows;
          tfDiv.appendChild(compTbl);
          div.appendChild(tfDiv);
        }

        out.appendChild(div);
      }
    }

    function makeCard(rec, title) {
      const card = document.createElement('div');
      card.className = 'card';
      if (!rec) { card.innerHTML = `<strong>${title}</strong><div class="muted">no rec</div>`; return card; }
      const lines = [];
      lines.push(`<strong>${title}</strong> <div class="muted">${rec.side}</div>`);
      lines.push(`<div>Delta: <strong>${rec.target_delta}</strong> &nbsp; Sigma: <strong>${rec.sigma_used}</strong> &nbsp; T: <strong>${rec.T_years}</strong></div>`);
      lines.push(`<div>ATM: <strong>${rec.strike_atm}</strong> Target: <strong>${rec.strike_target}</strong> Conservative: <strong>${rec.strike_conservative}</strong></div>`);
      if (rec.long_premium !== undefined || rec.leg_premium !== undefined) {
        lines.push(`<div>Long: <strong>${rec.long_premium ?? rec.leg_premium ?? '-'}</strong> Short: <strong>${rec.short_premium ?? '-'}</strong></div>`);
      }
      if (rec.spread_cost !== undefined) lines.push(`<div>Spread cost: <strong>${rec.spread_cost}</strong></div>`);
      if (rec.note) lines.push(`<div class="muted">${rec.note}</div>`);
      card.innerHTML = lines.join('');
      return card;
    }

    document.getElementById('run').addEventListener('click', () => callAnalyze(false));
    document.getElementById('force').addEventListener('click', () => callAnalyze(true));
  </script>
</body>
</html>
